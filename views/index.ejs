<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.1.3/dist/united/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="shortcut icon" type="image/x-icon" 
            href="https://storage.googleapis.com/aerial-rarity-387219.appspot.com/wvs%20logo%20favicon.ico" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <title>WVS: Website Vulnerability Scanner</title>
    <script>
        // handler for deleting entities & reports
        function deleteHandler(e, url)
        {
            fetch('/scans/'+url, {
                method:'delete',
                headers: {'Content-Type': 'application/json'},
                body:JSON.stringify({id:url})
            }).then(res=>{
                window.location.replace('/')
            })
        }

        // functions that hide the spinner once index is
        //  loaded, and show it when submitting the form
        function startSpinner()
        {
            $('#spinner').toggle();
        }
        $(document).ready(() => {
            $('#spinner').toggle();
        });
    </script>
  </head>
  <body class="container-fluid p-3">

    <h1>Website Vulnerability Scanner</h1>
    <h3>You are signed in as [<%= name %>]</h3>

    <img style="width: 10%; display: block; margin: auto;"
        src="https://storage.googleapis.com/aerial-rarity-387219.appspot.com/wvs%20logo.PNG" alt="WVS Logo" />
    <br />

    <form name="scanForm" action="/scan" method="POST" class="row d-flex justify-content-center align-items-center"
        onsubmit="startSpinner()">
        <div class="col-auto">
            <label for="targetURL" class="">Website to Scan</label>
            <input type="text" placeholder="https://www.example.com/" name="targetURL" 
            pattern="^((http|https):\/\/)[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&\/=]*)$" 
            required>
        </div>

        <div class="col-auto">
            <button type="submit" class="btn btn-primary">
                <span id="spinner" class="spinner-border spinner-border-sm" role="status"></span>
                Start Scan
            </button>
        </div>
    </form>
    <p class="text-center">Note: Scans have a tendency to last from a few seconds up to nearly a minute, 
        depending on the number of redirects found.</p>

    <h3>Recent Scans</h3>
    <table class="table table-striped container">
        <thead>
            <tr>
                <th>Target Website</th>
                <th>Date</th>
                <th>Scan Summary</th>
                <th>Download Report</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <%
            for (var i=0; i < userScans.length; i++) {
                %>
                <tr>
                    <td><%= userScans[i].targetURL%></td>
                    <td><%= userScans[i].scanDate%></td>
                    <td>Security Errors: <%=userScans[i].jsonStats.security %>
                        HTML Errors: <%=userScans[i].jsonStats.html %>
                        JavaScript Errors: <%=userScans[i].jsonStats.javascript %>
                        CSS Errors: <%=userScans[i].jsonStats.css %>
                        Image Errors: <%=userScans[i].jsonStats.image %>
                        Wordpress Errors: <%=userScans[i].jsonStats.wordpress %></td>
                    <td>  
                        <button class="btn">
                            <a href="<%= userScans[i].scanReportURL %>" download><i class="fa fa-download fa-2x"></i></a>
                        </button>
                    </td>
                    <td>
                        <button id="delete-button" class="btn" type="button" 
                            onclick="deleteHandler(this, '<%= userScans[i].url %>')">
                            Delete
                        </button>
                    </td>
                </tr>
                <%
            } %>
        </tbody>
    </table>

    <form action="/logout" method="POST">
        <input type="submit" class="btn btn-danger" value="Logout">
    </form>
  </body>
</html>